---
phase: 03-ui-implementation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Calculator.fs
  - src/App.fs
  - src/Main.fs
  - src/styles.css
  - tests/Tests.fs
autonomous: true

must_haves:
  truths:
    - "User sees 4-column CSS Grid button layout with 0-9, operators, decimal, clear, equals, backspace"
    - "User clicks button and sees hover highlight and active press effect"
    - "User presses keyboard keys (0-9, +, -, *, /, Enter, Escape, Backspace, .) and calculator responds"
    - "User presses Backspace and last character is deleted from display"
    - "Calculator layout fits mobile (375px) and desktop (1920px) screens"
  artifacts:
    - path: "src/Calculator.fs"
      provides: "BackspacePressed message in Msg DU"
      contains: "BackspacePressed"
    - path: "src/App.fs"
      provides: "CSS Grid view with keyboard handler and BackspacePressed update case"
      contains: "BackspacePressed"
    - path: "src/styles.css"
      provides: "Hover/active states for buttons, responsive media queries"
      contains: "calc-button:hover"
    - path: "src/Main.fs"
      provides: "CSS import via importSideEffects"
      contains: "importSideEffects"
    - path: "tests/Tests.fs"
      provides: "Unit tests for BackspacePressed behavior"
      contains: "BackspacePressed"
  key_links:
    - from: "src/App.fs"
      to: "src/styles.css"
      via: "prop.className on buttons"
      pattern: "prop\\.className.*calc-button"
    - from: "src/Main.fs"
      to: "src/styles.css"
      via: "Fable importSideEffects"
      pattern: "importSideEffects.*styles\\.css"
    - from: "src/App.fs"
      to: "Calculator.fs"
      via: "BackspacePressed dispatch in keyboard handler"
      pattern: "BackspacePressed"
---

<objective>
Implement the full calculator UI: add BackspacePressed logic, replace temporary flex buttons with CSS Grid layout, create external CSS for hover/active states, add keyboard event handling, and make layout responsive.

Purpose: Transform the temporary Phase 2 buttons into a production-quality calculator interface that works on both desktop and mobile.
Output: Working calculator with grid layout, visual button feedback, keyboard support, and Backspace functionality.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ui-implementation/03-RESEARCH.md

@src/Calculator.fs
@src/App.fs
@src/Main.fs
@tests/Tests.fs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add BackspacePressed message and update logic with unit tests</name>
  <files>src/Calculator.fs, src/App.fs, tests/Tests.fs</files>
  <action>
1. In `src/Calculator.fs`, add `BackspacePressed` to the `Msg` discriminated union (after `ClearPressed`):
   ```fsharp
   | BackspacePressed          // Backspace (delete last character)
   ```

2. In `src/App.fs`, add `BackspacePressed` case to the `update` function (after ClearPressed case):
   ```fsharp
   | BackspacePressed ->
       if model.Display = "Error" || model.Display = "0" then
           model, Cmd.none
       elif model.Display.Length = 1 then
           { model with Display = "0" }, Cmd.none
       else
           { model with Display = model.Display.[0..model.Display.Length-2] }, Cmd.none
   ```
   Key behaviors:
   - "Error" or "0" display: do nothing (no-op)
   - Single character: reset to "0" (never empty string)
   - Multiple characters: remove last character via F# string slicing

3. In `tests/Tests.fs`, add unit tests for BackspacePressed:
   - Backspace on "123" -> "12"
   - Backspace on "5" (single digit) -> "0"
   - Backspace on "0" -> "0" (no-op)
   - Backspace on "Error" -> "Error" (no-op, user must type digit to recover)
   - Backspace on "3.14" -> "3.1"
   - Backspace on "3." -> "3"

   Follow existing test patterns in Tests.fs (use `testCase` with `Expect.equal`).
  </action>
  <verify>
Run `npm test` from project root. All existing 27 tests plus new ~6 Backspace tests must pass (exit code 0).
  </verify>
  <done>
BackspacePressed message exists in Calculator.fs Msg type. Update function handles all edge cases (Error, "0", single char, multi-char). All unit tests pass including new Backspace tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: CSS Grid layout, external CSS, keyboard handler, responsive design</name>
  <files>src/styles.css, src/App.fs, src/Main.fs</files>
  <action>
1. Create `src/styles.css` with button styles and responsive design:
   ```css
   .calc-button {
       min-height: 44px;
       min-width: 44px;
       padding: 12px;
       font-size: 18px;
       border: 1px solid #ccc;
       background: #f0f0f0;
       cursor: pointer;
       border-radius: 4px;
       transition: all 0.1s ease;
       font-family: monospace;
   }
   .calc-button:hover {
       background: #e0e0e0;
       transform: scale(1.05);
   }
   .calc-button:active {
       background: #d0d0d0;
       transform: scale(0.95);
   }
   .calc-operator {
       background: #ff9500;
       color: white;
       border-color: #e68600;
   }
   .calc-operator:hover {
       background: #ff8000;
   }
   .calc-operator:active {
       background: #e67300;
   }
   .calc-equals {
       background: #4cd964;
       color: white;
       border-color: #3bb853;
   }
   .calc-equals:hover {
       background: #3cc954;
   }
   .calc-equals:active {
       background: #2db844;
   }
   .calc-clear {
       background: #ff3b30;
       color: white;
       border-color: #e6352b;
   }
   .calc-clear:hover {
       background: #ff2b20;
   }
   .calc-clear:active {
       background: #e6251a;
   }
   .calc-backspace {
       background: #8e8e93;
       color: white;
       border-color: #7c7c80;
   }
   .calc-backspace:hover {
       background: #7e7e83;
   }
   .calc-backspace:active {
       background: #6e6e73;
   }
   @media (max-width: 375px) {
       .calc-button {
           min-height: 48px;
           min-width: 48px;
           font-size: 16px;
       }
   }
   ```

2. In `src/Main.fs`, add CSS import BEFORE the Elmish program setup:
   ```fsharp
   open Fable.Core.JsInterop
   importSideEffects "./styles.css"
   ```
   Place after the `open` statements, before `Program.mkProgram`.

3. In `src/App.fs`, REPLACE the entire `view` function with CSS Grid layout + keyboard handler:

   Button layout (4 columns, top to bottom):
   - Row 1: C, BS (Backspace), (empty), ÷
   - Row 2: 7, 8, 9, ×
   - Row 3: 4, 5, 6, -
   - Row 4: 1, 2, 3, +
   - Row 5: 0 (span 2 columns), ., =

   The view function must:
   a. Wrap everything in a container div with `prop.tabIndex 0` for keyboard focus
   b. Add `prop.onKeyDown` with a handler that:
      - Calls `e.preventDefault()` for handled keys only
      - Pattern matches `e.key` for digits 0-9, operators +,-,*,/, Enter (=), Escape (C), Backspace, decimal
   c. Use CSS Grid with `repeat(4, 1fr)` for the button grid
   d. Keep the dark display area (green-on-black terminal style from Phase 2)
   e. Use `prop.className` for all buttons (not inline hover styles)
   f. Use `style.gridColumn "1 / 3"` for the 0 button to span 2 columns
   g. Set container maxWidth 400 and margin auto for centering
   h. Use `style.width (length.percent 90)` on outer container for mobile

   IMPORTANT anti-patterns to avoid:
   - Do NOT use inline styles for hover/active (use CSS classes)
   - Do NOT forget `prop.tabIndex 0` (keyboard events won't fire)
   - Do NOT forget `e.preventDefault()` for "/" and Backspace (browser steals these)
   - Do NOT use flexbox for the button grid (use CSS Grid)
   - Only call `e.preventDefault()` for keys the calculator handles (don't block Tab, etc.)
  </action>
  <verify>
1. Run `npm run dev` and verify calculator loads in browser
2. Run `npm test` — all tests still pass (view changes don't break update logic)
3. Visual check: buttons appear in 4-column grid with proper colors (orange operators, green equals, red clear)
  </verify>
  <done>
Calculator displays in 4-column CSS Grid. Buttons have hover highlight and active press animation (via CSS classes). Keyboard keys (0-9, +, -, *, /, Enter, Escape, Backspace, .) dispatch correct messages. Layout is centered with maxWidth 400 and responsive to mobile width. External CSS is loaded via importSideEffects in Main.fs.
  </done>
</task>

</tasks>

<verification>
1. `npm test` — all unit tests pass (existing 27 + new Backspace tests)
2. `npm run dev` — calculator loads with CSS Grid layout
3. Browser DevTools Elements panel shows grid layout on button container
4. Hover over any button — visual highlight appears
5. Click any button — press animation (scale down) visible
6. Press keyboard digits — calculator responds
7. Press Backspace — last character deleted
8. Resize browser to 375px width — buttons remain tappable (>= 44px)
</verification>

<success_criteria>
- Calculator renders 4-column CSS Grid with all buttons (0-9, +, -, ×, ÷, =, C, BS, .)
- Buttons show hover and active visual feedback via CSS pseudo-classes
- Keyboard input works for all calculator operations
- BackspacePressed deletes last character (or resets to "0" for single char)
- Layout responsive from 375px mobile to 1920px desktop
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-ui-implementation/03-01-SUMMARY.md`
</output>
