---
phase: 04-e2e-testing-and-ci
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - playwright.config.ts
  - e2e/calculator.spec.ts
  - src/App.fs
  - vite.config.js
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "Playwright test clicks '2 + 3 =' and display shows '5'"
    - "Playwright test verifies divide-by-zero shows 'Error'"
    - "Playwright tests run headless (no visible browser)"
    - "Test failures produce screenshots for debugging"
  artifacts:
    - path: "playwright.config.ts"
      provides: "Playwright configuration with webServer, headless, screenshot on failure"
      contains: "webServer"
    - path: "e2e/calculator.spec.ts"
      provides: "E2E test suite covering calculator operations"
      min_lines: 40
    - path: "src/App.fs"
      provides: "Display element with data-testid attribute"
      contains: "prop.testId"
  key_links:
    - from: "playwright.config.ts"
      to: "vite dev server"
      via: "webServer.command = npm run dev"
      pattern: "webServer.*npm run dev"
    - from: "e2e/calculator.spec.ts"
      to: "src/App.fs"
      via: "getByTestId('display') and getByRole('button')"
      pattern: "getByTestId.*display"
---

<objective>
Install Playwright, configure it for the Vite dev server, add data-testid to the display element, and write E2E tests that verify calculator operations in a real browser.

Purpose: Automated browser tests replace manual UI verification, ensuring calculator behavior is correct end-to-end.
Output: Working Playwright test suite that passes locally with `npx playwright test`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-e2e-testing-and-ci/04-RESEARCH.md
@src/App.fs
@vite.config.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Playwright and configure project</name>
  <files>package.json, playwright.config.ts, vite.config.js, src/App.fs, .gitignore</files>
  <action>
1. Install Playwright and TypeScript dev dependencies:
   ```bash
   npm install -D @playwright/test typescript @types/node
   npx playwright install chromium
   ```

2. Create `playwright.config.ts` at project root with this exact configuration:
   ```typescript
   import { defineConfig, devices } from '@playwright/test';

   export default defineConfig({
     testDir: './e2e',
     fullyParallel: true,
     forbidOnly: !!process.env.CI,
     retries: process.env.CI ? 2 : 0,
     workers: process.env.CI ? 1 : undefined,
     reporter: 'html',

     use: {
       baseURL: 'http://localhost:5173',
       trace: 'retain-on-failure',
       screenshot: 'only-on-failure',
       video: 'retain-on-failure',
     },

     projects: [
       {
         name: 'chromium',
         use: { ...devices['Desktop Chrome'] },
       },
     ],

     webServer: {
       command: 'npm run dev',
       url: 'http://localhost:5173',
       reuseExistingServer: !process.env.CI,
       timeout: 120 * 1000,
     },
   });
   ```

3. Add `strictPort: true` to `vite.config.js` to prevent port auto-increment:
   ```javascript
   server: {
     port: 5173,
     strictPort: true,
   },
   ```
   Add this `server` block inside the existing `defineConfig({...})` object, alongside `plugins` and `build`.

4. Add `data-testid="display"` to the display div in `src/App.fs`. Find the display div (the one with `prop.text model.Display` around line 131) and add `prop.testId "display"` to it. The prop should be added before `prop.text model.Display`. This is critical for Playwright locators.

5. Add `test:e2e` script to `package.json` scripts:
   ```json
   "test:e2e": "npx playwright test"
   ```

6. Add Playwright artifacts to `.gitignore`:
   ```
   # Playwright
   /test-results/
   /playwright-report/
   /blob-report/
   /playwright/.cache/
   ```
  </action>
  <verify>
  Run `npx playwright --version` to confirm installation. Run `cat playwright.config.ts` to verify config exists. Run `grep "testId" src/App.fs` to confirm data-testid is added. Run `grep "strictPort" vite.config.js` to confirm port locking.
  </verify>
  <done>Playwright installed, configured with webServer auto-start, display has data-testid="display", Vite port locked at 5173, test:e2e script available.</done>
</task>

<task type="auto">
  <name>Task 2: Write E2E test suite for calculator operations</name>
  <files>e2e/calculator.spec.ts</files>
  <action>
Create `e2e/calculator.spec.ts` with comprehensive E2E tests. The tests MUST use:
- `getByRole('button', { name: '...' })` for button clicks
- `getByTestId('display')` for display assertions
- `await expect(locator).toHaveText('...')` for web-first assertions (NOT manual textContent checks)
- `test.beforeEach` to navigate to '/' before each test

Button text values in the UI (from App.fs):
- Digits: "0" through "9"
- Operators: "+", "-", "×" (multiplication), "÷" (division)
- Other: ".", "=", "C", "←" (backspace)

NOTE: Multiplication button shows "×" (Unicode multiplication sign, U+00D7) NOT "*". Division button shows "÷" (Unicode division sign, U+00F7) NOT "/".

Write these test cases:

```typescript
import { test, expect } from '@playwright/test';

test.describe('Calculator E2E', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/');
  });

  test('displays initial state of 0', async ({ page }) => {
    await expect(page.getByTestId('display')).toHaveText('0');
  });

  test('adds two numbers: 2 + 3 = 5', async ({ page }) => {
    await page.getByRole('button', { name: '2' }).click();
    await page.getByRole('button', { name: '+' }).click();
    await page.getByRole('button', { name: '3' }).click();
    await page.getByRole('button', { name: '=' }).click();
    await expect(page.getByTestId('display')).toHaveText('5');
  });

  test('subtracts: 9 - 4 = 5', async ({ page }) => {
    await page.getByRole('button', { name: '9' }).click();
    await page.getByRole('button', { name: '-' }).click();
    await page.getByRole('button', { name: '4' }).click();
    await page.getByRole('button', { name: '=' }).click();
    await expect(page.getByTestId('display')).toHaveText('5');
  });

  test('multiplies: 6 × 7 = 42', async ({ page }) => {
    await page.getByRole('button', { name: '6' }).click();
    await page.getByRole('button', { name: '×' }).click();
    await page.getByRole('button', { name: '7' }).click();
    await page.getByRole('button', { name: '=' }).click();
    await expect(page.getByTestId('display')).toHaveText('42');
  });

  test('divides: 8 ÷ 2 = 4', async ({ page }) => {
    await page.getByRole('button', { name: '8' }).click();
    await page.getByRole('button', { name: '÷' }).click();
    await page.getByRole('button', { name: '2' }).click();
    await page.getByRole('button', { name: '=' }).click();
    await expect(page.getByTestId('display')).toHaveText('4');
  });

  test('shows Error on divide by zero', async ({ page }) => {
    await page.getByRole('button', { name: '5' }).click();
    await page.getByRole('button', { name: '÷' }).click();
    await page.getByRole('button', { name: '0' }).click();
    await page.getByRole('button', { name: '=' }).click();
    await expect(page.getByTestId('display')).toHaveText('Error');
  });

  test('clears display with C button', async ({ page }) => {
    await page.getByRole('button', { name: '5' }).click();
    await page.getByRole('button', { name: '3' }).click();
    await expect(page.getByTestId('display')).toHaveText('53');
    await page.getByRole('button', { name: 'C' }).click();
    await expect(page.getByTestId('display')).toHaveText('0');
  });

  test('handles decimal input', async ({ page }) => {
    await page.getByRole('button', { name: '3' }).click();
    await page.getByRole('button', { name: '.' }).click();
    await page.getByRole('button', { name: '5' }).click();
    await expect(page.getByTestId('display')).toHaveText('3.5');
  });

  test('chains operations left to right: 2 + 3 × 4 = 20', async ({ page }) => {
    await page.getByRole('button', { name: '2' }).click();
    await page.getByRole('button', { name: '+' }).click();
    await page.getByRole('button', { name: '3' }).click();
    await page.getByRole('button', { name: '×' }).click();
    // At this point 2+3=5 should be evaluated, display shows 5
    await expect(page.getByTestId('display')).toHaveText('5');
    await page.getByRole('button', { name: '4' }).click();
    await page.getByRole('button', { name: '=' }).click();
    await expect(page.getByTestId('display')).toHaveText('20');
  });

  test('backspace removes last digit', async ({ page }) => {
    await page.getByRole('button', { name: '1' }).click();
    await page.getByRole('button', { name: '2' }).click();
    await page.getByRole('button', { name: '3' }).click();
    await expect(page.getByTestId('display')).toHaveText('123');
    await page.getByRole('button', { name: '←' }).click();
    await expect(page.getByTestId('display')).toHaveText('12');
  });
});
```

IMPORTANT: For the getByRole('button', { name: '×' }) and getByRole('button', { name: '÷' }) locators, use the exact Unicode characters from the button text in App.fs. If Playwright cannot find these by name, fall back to using `page.locator('button', { hasText: '×' })` instead.
  </action>
  <verify>
  Run `npx playwright test` and confirm all tests pass. The output should show 10 passed tests. If any test fails, check the test-results/ directory for screenshots and fix the failing test.
  </verify>
  <done>10 E2E tests pass covering: initial state, addition, subtraction, multiplication, division, divide-by-zero error, clear, decimal, operation chaining, and backspace. All tests run headless.</done>
</task>

</tasks>

<verification>
1. `npx playwright test` — all 10 tests pass
2. `npx playwright test --headed` — tests visibly interact with calculator in browser (optional local check)
3. `npm test` — existing 33 unit tests still pass (no regressions)
4. `grep "testId" src/App.fs` — display has data-testid
5. `grep "strictPort" vite.config.js` — port locked
</verification>

<success_criteria>
- All 10 Playwright E2E tests pass headless
- Tests cover all 4 arithmetic operations + error + clear + decimal + chaining + backspace
- Display element has data-testid="display" for stable locators
- Vite port locked at 5173 with strictPort
- Screenshot/trace captured automatically on failure
- Existing unit tests unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/04-e2e-testing-and-ci/04-01-SUMMARY.md`
</output>
