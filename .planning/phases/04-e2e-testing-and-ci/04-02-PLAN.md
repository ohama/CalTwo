---
phase: 04-e2e-testing-and-ci
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - .github/workflows/ci.yml
  - package.json
autonomous: true

must_haves:
  truths:
    - "GitHub Actions runs all tests (unit + E2E) on every push to main"
    - "CI passes without any manual steps (fully automated)"
    - "Test failures upload screenshots as artifacts"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "CI workflow running unit + E2E tests"
      contains: "playwright test"
    - path: ".github/workflows/ci.yml"
      provides: "Artifact upload for test reports"
      contains: "upload-artifact"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "package.json"
      via: "npm ci, npm test, npx playwright test"
      pattern: "npm (ci|test)|playwright test"
    - from: ".github/workflows/ci.yml"
      to: "playwright-report/"
      via: "upload-artifact action"
      pattern: "playwright-report"
---

<objective>
Create a GitHub Actions CI workflow that runs both unit tests and Playwright E2E tests on every push and pull request, with proper caching and artifact uploads.

Purpose: Automated CI ensures every code change is verified without human intervention.
Output: `.github/workflows/ci.yml` that runs green on GitHub Actions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-e2e-testing-and-ci/04-RESEARCH.md
@.planning/phases/04-e2e-testing-and-ci/04-01-SUMMARY.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create `.github/workflows/ci.yml` with:

```yaml
name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - uses: actions/setup-node@v4
      with:
        node-version: 'lts/*'

    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

    - name: Install dependencies
      run: npm ci

    - name: Restore dotnet tools
      run: dotnet tool restore

    - name: Run unit tests
      run: npm test

    - name: Cache Playwright browsers
      uses: actions/cache@v4
      id: playwright-cache
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}

    - name: Install Playwright browsers
      if: steps.playwright-cache.outputs.cache-hit != 'true'
      run: npx playwright install --with-deps chromium

    - name: Install Playwright OS dependencies
      if: steps.playwright-cache.outputs.cache-hit == 'true'
      run: npx playwright install-deps chromium

    - name: Run E2E tests
      run: npx playwright test

    - name: Upload test report
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: test-results
        path: test-results/
        retention-days: 30
```

Key details:
- `actions/checkout@v4` (not v5 â€” v4 is the current stable)
- `actions/setup-dotnet@v4` is needed because unit tests use `dotnet fable` to compile F# to JS
- `dotnet-version: '9.0.x'` matches the project's .NET SDK requirement (check global.json)
- `actions/setup-node@v4` with LTS Node.js
- Cache both node_modules and Playwright browsers for faster runs
- Install only Chromium (not all browsers) to match playwright.config.ts
- Use `--with-deps` on first install, `install-deps` on cache hit (OS deps needed either way on CI)
- `if: ${{ !cancelled() }}` ensures artifacts upload even on test failure (critical for debugging)
- Upload both `playwright-report/` (HTML report) and `test-results/` (screenshots, traces)

IMPORTANT: Check `global.json` for the .NET SDK version. If it specifies a version like 9.0.xxx, use '9.0.x' in the workflow. If it specifies 8.0.xxx, use '8.0.x'.
  </action>
  <verify>
  Run `cat .github/workflows/ci.yml` and verify the YAML is valid. Run `yamllint .github/workflows/ci.yml 2>/dev/null || python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"` to validate YAML syntax. Verify the workflow includes: checkout, setup-dotnet, setup-node, npm ci, npm test, playwright install, playwright test, upload-artifact.
  </verify>
  <done>GitHub Actions workflow exists at `.github/workflows/ci.yml`, triggers on push/PR to main, runs unit tests and E2E tests, caches dependencies and Playwright browsers, uploads reports on failure.</done>
</task>

<task type="auto">
  <name>Task 2: Add CI-related npm script</name>
  <files>package.json</files>
  <action>
Add a `test:all` convenience script to `package.json` that runs both unit tests and E2E tests sequentially:

```json
"test:all": "npm test && npm run test:e2e"
```

This script is NOT used by CI (CI runs them separately for better error reporting), but is useful for local pre-push verification.
  </action>
  <verify>
  Run `npm run test:all` locally and verify both unit tests (33 passing) and E2E tests (10 passing) complete successfully.
  </verify>
  <done>`npm run test:all` runs both unit and E2E test suites. CI workflow runs them separately for granular failure reporting.</done>
</task>

</tasks>

<verification>
1. `.github/workflows/ci.yml` exists and is valid YAML
2. Workflow triggers on push and PR to main branch
3. Workflow installs .NET SDK, Node.js, npm deps, dotnet tools, Playwright
4. Workflow runs `npm test` (unit tests) and `npx playwright test` (E2E tests)
5. Workflow uploads playwright-report and test-results artifacts
6. `npm run test:all` passes locally
</verification>

<success_criteria>
- CI workflow file is valid YAML at `.github/workflows/ci.yml`
- Workflow triggers on push/PR to main
- Both unit tests and E2E tests run in CI
- Playwright browsers cached for faster CI runs
- Test artifacts (reports, screenshots) uploaded on failure
- `npm run test:all` works locally as pre-push check
</success_criteria>

<output>
After completion, create `.planning/phases/04-e2e-testing-and-ci/04-02-SUMMARY.md`
</output>
