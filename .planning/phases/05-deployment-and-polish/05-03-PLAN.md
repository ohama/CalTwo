---
phase: 05-deployment-and-polish
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - .github/workflows/deploy.yml
autonomous: false
user_setup:
  - service: github-pages
    why: "GitHub Pages deployment requires repository settings change (cannot be done via CLI)"
    dashboard_config:
      - task: "Set Pages source to GitHub Actions"
        location: "Repository Settings -> Pages -> Build and deployment -> Source -> GitHub Actions"

must_haves:
  truths:
    - "GitHub Actions builds and deploys to Pages on push to main"
    - "User visits GitHub Pages URL and calculator loads correctly"
    - "Deploy workflow includes .NET SDK for Fable compilation"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "Automated GitHub Pages deployment workflow"
      contains: "deploy-pages"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "vite.config.js"
      via: "npm run build uses base: '/CalTwo/' from vite config"
      pattern: "npm run build"
    - from: ".github/workflows/deploy.yml"
      to: "dist/"
      via: "upload-pages-artifact uploads dist/ directory"
      pattern: "path.*dist"
---

<objective>
Create GitHub Actions deployment workflow for GitHub Pages and verify deployment configuration.

Purpose: Automate deployment so every push to main automatically builds and deploys the calculator to https://ohama.github.io/CalTwo/. Includes human checkpoint for repository settings that cannot be automated.
Output: .github/workflows/deploy.yml with complete build-and-deploy pipeline.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-deployment-and-polish/05-RESEARCH.md

@.github/workflows/ci.yml
@vite.config.js
@package.json
@global.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Pages deployment workflow</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Create `.github/workflows/deploy.yml` based on the research template in 05-RESEARCH.md. The workflow must:

1. **Trigger**: On push to main branch AND workflow_dispatch (manual trigger for initial deploy)
2. **Permissions**: contents: read, pages: write, id-token: write
3. **Concurrency**: group 'pages', cancel-in-progress: true
4. **Job**: deploy with environment github-pages

Steps (in order):
1. `actions/checkout@v4` (match CI workflow version)
2. `actions/setup-dotnet@v4` with dotnet-version '10.0.x' (CRITICAL: Fable needs .NET SDK)
3. `actions/setup-node@v4` with node-version 'lts/*'
4. `dotnet tool restore` (restore Fable CLI)
5. `npm ci` (install dependencies)
6. `npm run build` (Fable compile + Vite production build)
7. `actions/configure-pages@v5` (setup Pages metadata)
8. `actions/upload-pages-artifact@v4` with path './dist' (upload build output)
9. `actions/deploy-pages@v4` with id 'deployment' (deploy to Pages)

Important: Use actions/checkout@v4 and actions/setup-node@v4 (matching existing ci.yml versions), NOT v5/v6 from research. The research template uses newer versions but consistency with ci.yml is more important. However, use actions/configure-pages@v5, actions/upload-pages-artifact@v4, and actions/deploy-pages@v4 as these are new actions not in ci.yml.

Add URL output: `url: ${{ steps.deployment.outputs.page_url }}` on the environment.
  </action>
  <verify>
Read .github/workflows/deploy.yml and verify: (1) has permissions block, (2) includes setup-dotnet step with 10.0.x, (3) includes dotnet tool restore, (4) npm run build step exists, (5) upload artifact points to './dist', (6) deploy-pages step has id 'deployment'. YAML syntax check: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy.yml'))"` or verify manually.
  </verify>
  <done>deploy.yml exists with complete build-and-deploy pipeline including .NET SDK setup, Fable compilation, Vite build, and GitHub Pages deployment via official actions.</done>
</task>

<task type="auto">
  <name>Task 2: Verify production build locally</name>
  <files></files>
  <action>
Run the production build to verify it works before deployment:

1. Run `npm run build` — should complete without errors
2. Check dist/ directory exists and contains index.html, assets/ directory
3. Verify asset paths in dist/index.html contain '/CalTwo/' prefix
4. If build fails, diagnose and fix the issue

This task validates that the Vite base path config from Plan 01 produces correct output. Do NOT modify any files — just verify.
  </action>
  <verify>
`npm run build` exits with code 0. `ls dist/` shows index.html and assets/. `grep "CalTwo" dist/index.html` shows asset references with /CalTwo/ prefix.
  </verify>
  <done>Production build completes successfully. dist/ contains index.html with correct /CalTwo/ asset paths.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Configure GitHub Pages settings</name>
  <action>
This step requires manual configuration in the GitHub repository settings. Claude cannot automate this.
  </action>
  <how-to-verify>
1. Go to https://github.com/ohama/CalTwo/settings/pages
2. Under "Build and deployment", find the "Source" dropdown
3. Select "GitHub Actions" (NOT "Deploy from a branch")
4. Save the setting
5. Push the deploy.yml to main — the workflow should trigger automatically
6. After workflow completes, visit https://ohama.github.io/CalTwo/ to verify the calculator loads
  </how-to-verify>
  <resume-signal>Type "deployed" when the calculator is accessible at the GitHub Pages URL, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
1. `.github/workflows/deploy.yml` exists with correct structure
2. `npm run build` succeeds locally
3. dist/index.html references assets with /CalTwo/ prefix
4. (After human action) Calculator loads at https://ohama.github.io/CalTwo/
</verification>

<success_criteria>
- deploy.yml creates a complete CI/CD pipeline: checkout -> dotnet setup -> node setup -> build -> deploy
- Production build generates correct static files for GitHub Pages
- GitHub Pages source configured to use GitHub Actions
- Calculator accessible at https://ohama.github.io/CalTwo/ after deployment
</success_criteria>

<output>
After completion, create `.planning/phases/05-deployment-and-polish/05-03-SUMMARY.md`
</output>
